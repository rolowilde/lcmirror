---
- name: Configure a repository mirror server
  hosts: mirrors
  become: true
  roles:
    - role: common
      tags: always

    - role: robertdebock.update
      tags: update

    - role: robertdebock.users
      vars:
        users: "{{ common_users | default([]) }}"
      tags: users

    - role: archlinux
      tags: archlinux
      when: archlinux | default(True)

    - role: debian
      tags: debian
      when: debian | default(True)

    - role: ubuntu
      tags: ubuntu
      when: ubuntu | default(True)

    - role: freebsd
      tags: freebsd
      when: freebsd | default(True)

    - role: mxlinux
      tags: mxlinux
      when: mxlinux | default(True)

    - role: linuxmint
      tags: linuxmint
      when: linuxmint | default(True)

    - role: fedora
      tags: fedora
      when: fedora | default(True)

    - role: maxhoesel.caddy.caddy_server
      tags: caddy
      when: caddy | default(True)

    - role: infOpen.rsync-server
      vars:
        rsync_server_group:
          name: "{{ common_rsync_user }}"
        rsync_server_user:
          name: "{{ common_rsync_user }}"
        rsync_default_global_config: |-
          uid = {{ common_rsync_user }}
          gid = {{ common_rsync_user }}
          log file = /var/log/rsync/rsyncd.log
        rsync_server_config_main:
          global: "{{ rsync_global_config | default(rsync_default_global_config) }}"
          modules: "{{ common_rsync_modules | default([]) }}"
      tags: rsyncd
      when: rsyncd | default(True)

    - role: robertdebock.vsftpd
      vars:
        vsftpd_nopriv_user: "{{ common_vsftpd_user }}"
      tags: vsftpd
      when: vsftpd | default(True)

    - role: robertdebock.cron
      vars:
        cron_jobs: "{{ common_cron_jobs | default([]) }}"
      tags: cron
  tasks:
    - name: Perform rsyncd tasks
      tags: rsyncd
      when: rsyncd | default(True)
      block:
        - name: Enable and start rsyncd
          ansible.builtin.service:
            name: "{{ rsync_server_service.name }}" # from role
            enabled: true
            state: started

    - name: Perform vsftpd tasks
      tags: vsftpd
      when: vsftpd | default(True)
      vars:
        vsftpd_userlist_file: /etc/vsftpd.user_list
        vsftpd_files:
          - vsftpd_xferlog_file
          - vsftpd_banned_email_file
          - vsftpd_chroot_list_file
          - vsftpd_userlist_file
      block:
        - name: Create vsftpd directories
          ansible.builtin.file:
            path: "{{ lookup('ansible.builtin.vars', item) | ansible.builtin.dirname }}"
            mode: '0755'
            state: directory
          loop: "{{ vsftpd_files }}"

        - name: Touch vsftpd files
          ansible.builtin.file:
            path: "{{ lookup('ansible.builtin.vars', item) }}"
            mode: '0644'
            state: touch
          loop: "{{ vsftpd_files }}"

        - name: Create vsftpd files with content
          ansible.builtin.copy:
            content: "{{ lookup('ansible.builtin.vars', item[:-5]) }}" # same var without _file
            dest: "{{ lookup('ansible.builtin.vars', item) }}"
            mode: '0644'
          loop: "{{ vsftpd_files }}"
          notify: Restart vsftpd
          when: lookup('ansible.builtin.vars', item[:-5]) | default('', true) | trim != ''

        - name: Symlink anonymous ftp root to rsync root
          ansible.builtin.file:
            src: "{{ common_rsync_root }}"
            dest: "{{ common_vsftpd_root }}"
            force: true
            state: link
